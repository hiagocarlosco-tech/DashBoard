import React, { useState, useMemo } from "react";
import {
  Users,
  BarChart3,
  FileText,
  ShoppingBag,
  Settings,
  Plus,
  Trash2,
  Zap,
  FilePlus,
  Package,
  Star
} from "lucide-react";

// HotSushiManagement.jsx
// Sistema completo de gest√£o (front-end demo) com controle de estoque, fornecedores,
// fichas t√©cnicas, consumo autom√°tico por pedido e integra√ß√µes (Yooga).

export default function HotSushiManagement() {
  const [activeTab, setActiveTab] = useState("dashboard");

  /* ======= DADOS PRINCIPAIS (ESTADO) ======= */
  const [team, setTeam] = useState([
    { id: 1, name: "Hiago", role: "Gerente", shift: "Integral", performance: 98 },
    { id: 2, name: "Ian", role: "Sushiman", shift: "Noite", performance: 95 }
  ]);

  const [pedidos, setPedidos] = useState([
    { id: "#4521", channel: "Yooga", cliente: "Jo√£o Silva", items: [{ sku: "SUS-02", qty: 2 }], status: "Preparando", responsavel: "Ian", tempo: 18, valor: 132 }
  ]);

  const [stock, setStock] = useState([
    { id: 'ING-001', sku: 'SAL-01', name: 'Salm√£o (kg)', unit: 'kg', qty: 25, cost: 50.0, minStock: 20, supplierId: 'F1' },
    { id: 'ING-002', sku: 'ARZ-01', name: 'Arroz (kg)', unit: 'kg', qty: 12, cost: 6.0, minStock: 10, supplierId: 'F2' },
    { id: 'ING-003', sku: 'NORI-01', name: 'Nori (un)', unit: 'un', qty: 200, cost: 0.8, minStock: 50, supplierId: 'F3' }
  ]);

  const [suppliers, setSuppliers] = useState([
    { id: 'F1', name: 'Peixes do Porto', contact: 'contato@peixes.com', leadDays: 2 },
    { id: 'F2', name: 'Arroz Bom', contact: 'vendas@arroz.com', leadDays: 3 },
    { id: 'F3', name: 'Alga Master', contact: 'comercial@nori.com', leadDays: 5 }
  ]);

  const [recipes, setRecipes] = useState([
    { sku: 'SUS-02', name: 'Sushi Salm√£o (un)', ingredients: [{ sku: 'SAL-01', qty: 0.12, unit: 'kg' }, { sku: 'ARZ-01', qty: 0.08, unit: 'kg' }, { sku: 'NORI-01', qty: 1, unit: 'un' }], price: 66 }
  ]);

  const [purchaseOrders, setPurchaseOrders] = useState([]);
  const [movements, setMovements] = useState([]); 

  const [settings, setSettings] = useState({
    tempoMaximo: 15,
    integracaoYooga: false,
    yoogaApiKey: '',
    autoReorder: true,
    reorderMultiplier: 1.5 
  });

  /* ======= HELPERS E C√ÅLCULOS (useMemo) ======= */
  const stockValue = useMemo(() => stock.reduce((s, i) => s + (i.qty * i.cost), 0), [stock]);
  const lowStock = useMemo(() => stock.filter(i => i.qty <= i.minStock), [stock]);

  /* ======= FUN√á√ïES DE GEST√ÉO (APENAS O ESSENCIAL) ======= */
  function addStockItem(item) {
    setStock(prev => [...prev, { ...item, id: item.id || `ING-${Date.now()}` }]);
    logMovement({ type: 'entrada', sku: item.sku, qty: item.qty, note: 'Cadastro inicial' });
  }

  function adjustStock(sku, newQty, reason = 'Ajuste manual') {
    const qtyChange = newQty - (stock.find(i => i.sku === sku)?.qty || 0);
    setStock(prev => prev.map(i => i.sku === sku ? { ...i, qty: newQty } : i));
    logMovement({ type: 'ajuste', sku, qty: qtyChange, note: reason });
  }

  function logMovement({ type, sku, qty, note }) {
    setMovements(prev => [{ type, sku, qty, note, date: new Date() }, ...prev]);
  }

  function createPurchaseOrdersForLowStock() {
    const orders = lowStock.map(item => {
      const supplier = suppliers.find(s => s.id === item.supplierId) || { id: 'UNK' };
      const orderQty = Math.max(Math.ceil(item.minStock * settings.reorderMultiplier - item.qty), 1);
      return {
        id: `PO-${Date.now()}-${item.sku}`,
        supplierId: supplier.id,
        supplierName: supplier.name,
        sku: item.sku,
        qty: orderQty,
        etaDays: supplier.leadDays,
        status: 'open',
        createdAt: new Date()
      };
    });

    setPurchaseOrders(prev => [...orders, ...prev]);
    return orders;
  }

  function receivePurchaseOrder(poId) {
    const po = purchaseOrders.find(p => p.id === poId);
    if (!po) return;
    setStock(prev => prev.map(i => i.sku === po.sku ? { ...i, qty: Number(i.qty) + Number(po.qty) } : i));
    setPurchaseOrders(prev => prev.map(p => p.id === poId ? { ...p, status: 'received', receivedAt: new Date() } : p));
    logMovement({ type: 'entrada', sku: po.sku, qty: po.qty, note: `Recebido PO ${poId}` });
  }
  
  function consumeIngredientsFromOrder(order) {
    let toConsume = [];
    order.items.forEach(orderItem => {
      const recipe = recipes.find(r => r.sku === orderItem.sku);
      if (!recipe) return; 
      recipe.ingredients.forEach(ing => {
        toConsume.push({ sku: ing.sku, qty: ing.qty * orderItem.qty });
      });
    });

    setStock(prev => prev.map(item => {
      const c = toConsume.filter(t => t.sku === item.sku).reduce((s, x) => s + x.qty, 0);
      if (c > 0) {
        logMovement({ type: 'saida', sku: item.sku, qty: -c, note: `Consumo por pedido ${order.id}` });
        return { ...item, qty: Math.max(0, Number(item.qty) - c) };
      }
      return item;
    }));
  }

  function finalizarPedido(pedidoId) {
    const order = pedidos.find(p => p.id === pedidoId);
    if (!order) return;
    consumeIngredientsFromOrder(order);
    setPedidos(prev => prev.map(p => p.id === pedidoId ? { ...p, status: 'Pronto' } : p));
  }

  function fetchPedidosFromYooga() {
      const id = `#YOOGA-${Math.floor(Math.random()*9999)}`; 
      const newP = { id, channel: 'Yooga (Sim)', cliente: 'Cliente Yooga', items: [{ sku: 'SUS-02', qty: 1 }], status: 'Novo', responsavel: 'Cozinha', tempo: Math.floor(Math.random() * 25), valor: 66 }; 
      setPedidos(prev => [newP, ...prev]);
      alert(`Pedido Yooga simulado recebido: ${id}.`);
  }
  
  function exportStockCSV() {
    const header = 'sku,name,unit,qty,cost,minStock,supplier\n';
    const rows = stock.map(i => `${i.sku},"${i.name}",${i.unit},${i.qty},${i.cost},${i.minStock},${i.supplierId}\n`).join('');
    const csv = header + rows;
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `estoque-${new Date().toISOString()}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  /* ======= UI (TAILWIND) ======= */
  return (
    <div className="min-h-screen bg-gray-50">
      <header className="bg-gradient-to-r from-red-600 to-orange-600 text-white p-6 shadow">
        <div className="max-w-6xl mx-auto flex justify-between">
          <div>
            <h1 className="text-3xl font-bold">üç£ Hot Sushi Lounge ‚Äî Painel Operacional</h1>
            <div className="text-sm opacity-90">Gerente: Hiago ‚Ä¢ Controle total de opera√ß√£o e estoque</div>
          </div>
          <div className="text-right">
            <div className="font-bold">Valor em estoque: R$ {stockValue.toFixed(2)}</div>
            <div className="text-xs opacity-90">Itens cr√≠ticos: {lowStock.length}</div>
          </div>
        </div>
      </header>

      <nav className="bg-white shadow mt-4">
        <div className="max-w-6xl mx-auto flex overflow-x-auto">
          {[ { id: 'dashboard', label: 'Dashboard', icon: <BarChart3 /> }, { id: 'estoque', label: 'Estoque', icon: <Package /> }, { id: 'pedidos', label: 'Pedidos', icon: <ShoppingBag /> }, { id: 'equipe', label: 'Equipe', icon: <Users /> }, { id: 'fornecedores', label: 'Fornecedores', icon: <FilePlus /> }, { id: 'config', label: 'Configura√ß√µes', icon: <Settings /> }, { id: 'relatorios', label: 'Relat√≥rios', icon: <FileText /> } ].map(tab => (
            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`px-6 py-4 font-semibold border-b-4 ${activeTab===tab.id? 'border-red-600 text-red-600':'border-transparent text-gray-600'}`}>
              <div className="flex items-center gap-2">{tab.icon}{tab.label}</div>
            </button>
          ))}
        </div>
      </nav>

      <main className="max-w-6xl mx-auto p-6 space-y-6">
        
        {/* DASHBOARD */}
        {activeTab === 'dashboard' && (
          <section className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div className="bg-white p-4 rounded shadow">
              <div className="text-sm text-gray-500">Pedidos Ativos</div>
              <div className="text-2xl font-bold">{pedidos.filter(p => p.status !== 'Pronto').length}</div>
              <div className="text-xs text-gray-400">Integra√ß√£o: {settings.integracaoYooga ? 'Yooga' : 'Simula√ß√£o'}</div>
            </div>
            
            <div className="bg-white p-4 rounded shadow">
              <div className="text-sm text-gray-500">Itens com estoque cr√≠tico</div>
              <div className="text-2xl font-bold">{lowStock.length}</div>
              <div className="text-xs text-gray-400">Pr√≥xima a√ß√£o: Criar PO</div>
            </div>
            
            <div className="bg-white p-4 rounded shadow">
              <div className="text-sm text-gray-500">Valor do Estoque</div>
              <div className="text-2xl font-bold">R$ {stockValue.toFixed(2)}</div>
              <div className="text-xs text-gray-400">Custo estimado</div>
            </div>
            
            <div className="bg-white p-4 rounded shadow">
              <div className="flex flex-col h-full justify-between">
                <div className="text-sm text-gray-500">A√ß√µes R√°pidas</div>
                <div className="flex gap-2 mt-2">
                  <button className="bg-green-600 text-white px-3 py-2 rounded flex items-center gap-1 text-sm" onClick={() => { const orders = createPurchaseOrdersForLowStock(); if (orders.length) alert(`${orders.length} PO(s) criadas`); else alert('Nenhum item cr√≠tico encontrado'); }}><Zap size={14} /> Criar PO</button>
                  <button className="bg-blue-600 text-white px-3 py-2 rounded text-sm" onClick={fetchPedidosFromYooga}>Sincronizar Yooga</button>
                </div>
              </div>
            </div>
          </section>
        )}

        {/* ESTOQUE */}
        {activeTab === 'estoque' && (
          <section className="bg-white p-6 rounded shadow space-y-4">
            <div className="flex justify-between items-center">
              <h2 className="text-xl font-bold">Controle de Estoque</h2>
              <div className="flex gap-2">
                <button className="bg-green-600 text-white px-3 py-2 rounded flex items-center gap-1 text-sm" onClick={() => addStockItem({ sku: `NEW-${Date.now()}`, name: 'Novo Ingrediente', unit: 'un', qty: 0, cost: 0, minStock: 1, supplierId: suppliers[0]?.id })}><Plus size={14} /> Novo Item</button>
                <button className="bg-gray-100 px-3 py-2 rounded text-sm" onClick={exportStockCSV}>Exportar CSV</button>
              </div>
            </div>

            <div className="overflow-x-auto">
              <table className="w-full table-auto text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="p-2 text-left">SKU</th>
                    <th className="p-2 text-left">Nome</th>
                    <th className="p-2">Un</th>
                    <th className="p-2">Qtd</th>
                    <th className="p-2">Custo</th>
                    <th className="p-2">M√≠n</th>
                    <th className="p-2">Fornecedor</th>
                    <th className="p-2">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody>
                  {stock.map(item => (
                    <tr key={item.sku} className={`${item.qty <= item.minStock ? 'bg-red-50' : ''} border-b`}>
                      <td className="p-2 font-semibold">{item.sku}</td>
                      <td className="p-2">{item.name}</td>
                      <td className="p-2 text-center">{item.unit}</td>
                      <td className="p-2 text-center">{item.qty}</td>
                      <td className="p-2 text-right">R$ {Number(item.cost).toFixed(2)}</td>
                      <td className="p-2 text-center">{item.minStock}</td>
                      <td className="p-2">{suppliers.find(s => s.id === item.supplierId)?.name || '‚Äî'}</td>
                      <td className="p-2 text-right">
                        <button className="text-xs px-2 py-1 bg-gray-100 rounded" onClick={() => adjustStock(item.sku, Number(prompt('Nova quantidade para ' + item.sku, String(item.qty))) || item.qty, 'Contagem r√°pida')}>Ajustar</button>
                        <button className="text-xs px-2 py-1 ml-2 bg-red-100 rounded" onClick={() => { if (confirm('Remover item do estoque?')) setStock(prev => prev.filter(i => i.sku !== item.sku)); }}><Trash2 size={14} /></button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            
            <div className="pt-4 border-t">
              <h3 className="font-semibold">Movimenta√ß√µes recentes (Max 10)</h3>
              <ul className="text-sm mt-2 space-y-1">
                {movements.slice(0,10).map((m,i) => (
                  <li key={i} className="flex gap-2 text-xs">
                    <span className="text-gray-500 w-1/4">{new Date(m.date).toLocaleTimeString('pt-BR')}</span>
                    <span className={`font-semibold ${m.qty > 0 ? 'text-green-600' : 'text-red-600'}`}>{m.type.toUpperCase()}</span> 
                    <span className="w-1/4">{m.sku}</span>
                    <span className="w-1/6 text-right">{m.qty}</span>
                    <span className="text-gray-600">{m.note}</span>
                  </li>
                ))}
              </ul>
            </div>
          </section>
        )}

        {/* PEDIDOS */}
        {activeTab === 'pedidos' && (
          <section className="bg-white p-6 rounded shadow space-y-4">
            <div className="flex justify-between items-center">
              <h2 className="text-xl font-bold">Pedidos Ativos ({pedidos.filter(p => p.status !== 'Pronto').length})</h2>
              <div>
                <button className="bg-blue-600 text-white px-3 py-2 rounded mr-2 text-sm" onClick={fetchPedidosFromYooga}>Buscar Yooga (Sim.)</button>
                <button className="bg-green-600 text-white px-3 py-2 rounded text-sm" onClick={() => { const id = `#SIM-${Math.floor(Math.random()*9999)}`; const newP = { id, channel: 'Manual', cliente: 'Mesa 5', items: [{ sku: 'SUS-02', qty: 1 }], status: 'Novo', responsavel: 'Cozinha', tempo: 0, valor: 66 }; setPedidos(prev => [newP, ...prev]); alert('Pedido simulado criado: ' + id); }}>Simular Pedido</button>
              </div>
            </div>

            <div className="space-y-3">
              {pedidos.filter(p => p.status !== 'Pronto').map(p => (
                <div key={p.id} className="border rounded p-4 flex justify-between items-center bg-gray-50 hover:shadow-md">
                  <div>
                    <div className="font-bold">{p.id} ‚Ä¢ {p.cliente} <span className="text-xs text-gray-500">({p.channel})</span></div>
                    <div className="text-sm text-gray-600 mt-1">
                      {p.items?.map(it => `${it.sku} x${it.qty}`).join(' | ')}
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    <div className={`font-bold text-lg ${p.tempo > settings.tempoMaximo ? 'text-red-600' : 'text-gray-700'}`}>{p.tempo} min</div>
                    <button className="px-3 py-2 bg-red-600 text-white rounded text-sm" onClick={() => { finalizarPedido(p.id); alert(`Pedido ${p.id} finalizado e estoque consumido!`); }}>Finalizar</button>
                    <button className="px-3 py-2 bg-gray-200 rounded text-sm" onClick={() => setPedidos(prev => prev.filter(x => x.id !== p.id))}><Trash2 size={16} /></button>
                  </div>
                </div>
              ))}
            </div>
          </section>
        )}

        {/* EQUIPE */}
        {activeTab === 'equipe' && (
          <section className="bg-white p-6 rounded shadow space-y-4">
            <h2 className="text-xl font-bold">Gest√£o de Equipe</h2>
            <div className="space-y-3">
              {team.map(m => (
                <div key={m.id} className="flex justify-between items-center border p-3 rounded">
                  <div>
                    <div className="font-bold">{m.name}</div>
                    <div className="text-sm text-gray-600">{m.role} ‚Ä¢ {m.shift}</div>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="text-sm font-semibold text-green-600">{m.performance}% Desempenho</div>
                    <Star size={16} className="text-yellow-500"/>
                  </div>
                </div>
              ))}
            </div>
             <button className="mt-4 bg-gray-100 text-gray-700 px-3 py-2 rounded text-sm flex items-center gap-1" onClick={() => setTeam(prev => [...prev, { id: Date.now(), name: 'Novo Membro', role: 'Ajustar', shift: 'Ajustar', performance: 0 }])}><Plus size={14}/> Adicionar Membro</button>
          </section>
        )}

        {/* FORNECEDORES */}
        {activeTab === 'fornecedores' && (
          <section className="bg-white p-6 rounded shadow space-y-4">
            <div className="flex justify-between items-center">
              <h2 className="text-xl font-bold">Fornecedores & Pedidos de Compra</h2>
              <button className="bg-green-600 text-white px-3 py-2 rounded flex items-center gap-1 text-sm" onClick={() => setSuppliers(prev => [...prev, { id: `F${Date.now()}`, name: 'Novo Fornecedor', contact: '', leadDays: 3 }])}><Plus size={14}/> Novo Fornecedor</button>
            </div>
            
            <h3 className="font-semibold text-lg border-b pb-2">Pedidos de Compra (PO) em Aberto</h3>
            <ul className="text-sm space-y-2">
                {purchaseOrders.filter(p => p.status === 'open').map(po => (
                    <li key={po.id} className="flex justify-between items-center p-3 border rounded bg-yellow-50">
                        <span>**{po.id}** | {po.sku} x{po.qty} | **{po.supplierName}** | ETA: {po.etaDays} dias</span>
                        <button className="bg-red-600 text-white px-2 py-1 rounded text-xs" onClick={() => receivePurchaseOrder(po.id)}>Receber Mercadoria</button>
                    </li>
                ))}
                {purchaseOrders.filter(p => p.status === 'open').length === 0 && <li className="text-gray-500 p-2">Nenhum PO em aberto.</li>}
            </ul>

            <h3 className="font-semibold text-lg border-b pb-2 pt-4">Lista de Fornecedores</h3>
            <div className="space-y-3">
              {suppliers.map(s => (
                <div key={s.id} className="flex justify-between items-center border p-3 rounded bg-gray-50">
                  <div>
                    <div className="font-bold">{s.name}</div>
                    <div className="text-sm text-gray-600">{s.contact} ‚Ä¢ Prazo: {s.leadDays} dias</div>
                  </div>
                  <div>
                    <button className="px-2 py-1 bg-gray-100 rounded text-xs" onClick={() => setSuppliers(prev => prev.map(x => x.id === s.id ? { ...x, name: prompt('Nome do fornecedor', s.name) || s.name } : x))}>Editar</button>
                     <button className="px-2 py-1 ml-2 bg-red-100 rounded text-xs" onClick={() => { if (confirm('Remover fornecedor?')) setSuppliers(prev => prev.filter(x => x.id !== s.id)); }}><Trash2 size={14} /></button>
                  </div>
                </div>
              ))}
            </div>
          </section>
        )}

        {/* CONFIGURA√á√ïES */}
        {activeTab === 'config' && (
          <section className="bg-white p-6 rounded shadow space-y-4">
            <h2 className="text-xl font-bold">Configura√ß√µes e Integra√ß√£o</h2>
            
            <div className="p-3 border rounded">
              <h3 className="font-semibold mb-2">Operacional</h3>
              <label className="block font-medium">Tempo m√°ximo de preparo (min)</label>
              <input type="number" value={settings.tempoMaximo} onChange={e => setSettings({ ...settings, tempoMaximo: Number(e.target.value) })} className="border p-2 rounded w-32" />
            </div>

            <div className="p-3 border rounded">
              <h3 className="font-semibold mb-2">Estoque e Reposi√ß√£o</h3>
              <label className="flex items-center gap-2 mb-2"><input type="checkbox" checked={settings.autoReorder} onChange={e => setSettings({ ...settings, autoReorder: e.target.checked })} /> Reposi√ß√£o autom√°tica</label>
              <label className="block mt-2 font-medium">Multiplicador de reposi√ß√£o (x)</label>
              <input type="number" value={settings.reorderMultiplier} step={0.1} onChange={e => setSettings({ ...settings, reorderMultiplier: Number(e.target.value) })} className="border p-2 rounded w-32" />
            </div>

            <div className="p-3 border rounded bg-blue-50">
              <h3 className="font-semibold mb-2">Integra√ß√£o Yooga</h3>
              <label className="flex items-center gap-2"><input type="checkbox" checked={settings.integracaoYooga} onChange={e => setSettings({ ...settings, integracaoYooga: e.target.checked })} /> Ativar integra√ß√£o Yooga</label>
              {settings.integracaoYooga && (
                <div className="mt-2 space-y-2">
                  <label className="block font-medium">Yooga API Key</label>
                  <input type="text" value={settings.yoogaApiKey} onChange={e => setSettings({ ...settings, yoogaApiKey: e.target.value })} className="border p-2 rounded w-full" placeholder="Chave de API (N√£o use no Front-end em produ√ß√£o)" />
                  <p className="text-sm text-gray-600">Este painel usa simula√ß√£o. Para integra√ß√£o real, √© necess√°rio um backend que utilize a chave API Yooga para receber webhooks ou fazer polling.</p>
                </div>
              )}
            </div>
          </section>
        )}

        {/* RELAT√ìRIOS */}
        {activeTab === 'relatorios' && (
          <section className="bg-white p-6 rounded shadow space-y-4">
            <h2 className="text-xl font-bold">Relat√≥rios e An√°lises</h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="p-4 bg-white rounded shadow border">
                <div className="text-sm text-gray-500">Custo Total do Estoque</div>
                <div className="text-2xl font-bold text-red-700">R$ {stockValue.toFixed(2)}</div>
              </div>
              <div className="p-4 bg-white rounded shadow border">
                <div className="text-sm text-gray-500">Pedidos Finalizados</div>
                <div className="text-2xl font-bold text-blue-600">{pedidos.filter(p => p.status === 'Pronto').length}</div>
              </div>
              <div className="p-4 bg-white rounded shadow border">
                <div className="text-sm text-gray-500">Itens Cr√≠ticos</div>
                <div className="text-2xl font-bold text-yellow-600">{lowStock.length}</div>
              </div>
            </div>

            <div className="pt-4 border-t">
              <h3 className="font-semibold mt-4">Exportar Dados Operacionais</h3>
              <div className="mt-2 flex gap-2">
                <button className="bg-blue-600 text-white px-3 py-2 rounded text-sm">Exportar Vendas (CSV)</button>
                <button className="bg-gray-100 px-3 py-2 rounded text-sm">Exportar Movimenta√ß√µes (CSV)</button>
              </div>
            </div>
          </section>
        )}
      </main>

      <footer className="text-center text-xs text-gray-500 p-4">Painel demo (Front-end apenas) ‚Ä¢ √â necess√°rio backend para persist√™ncia, autentica√ß√£o e integra√ß√µes reais.</footer>
    </div>
  );
}
